<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <title>Viem + Audius + Monaco Playground</title>

  <!-- Monaco Loader -->
  <script src="https://cdn.jsdelivr.net/npm/monaco-editor@0.34.1/min/vs/loader.js"></script>

  <!-- Audius SDK -->
  <script src="https://cdn.jsdelivr.net/npm/@audius/sdk@latest/dist/sdk.min.js"></script>

  <style>
    html,
    body {
      margin: 0;
      padding: 0;
      height: 100%;
    }

    #container {
      display: flex;
      height: 100vh;
      width: 100vw;
    }

    #editor {
      flex: 1;
    }

    #console {
      width: 30%;
      background: #1e1e1e;
      color: #dcdcdc;
      display: flex;
      flex-direction: column;
      padding: 1rem;
      font-family: monospace;
    }

    button {
      padding: 0.5rem;
      margin-bottom: 0.5rem;
      width: 100%;
      cursor: pointer;
      background: #007acc;
      border: none;
      color: white;
      font-size: 1rem;
    }

    #output {
      flex: 1;
      overflow: auto;
      margin: 0;
      padding: 0.5rem;
      background: #1e1e1e;
      font-family: monospace;
      white-space: pre-wrap;
    }
  </style>
</head>

<body>
  <div id="container">
    <div id="editor"></div>
    <div id="console">
      <button id="runBtn">â–¶ Run</button>
      <pre id="output"></pre>
    </div>
  </div>

  <!-- Load Viem and expose to window -->
  <script type="module">
    import * as viem from 'https://esm.sh/viem';
    import { mainnet } from 'https://esm.sh/viem/chains';
    window.viem = { ...viem, mainnet };
    console.log("âœ… Viem loaded");
  </script>

  <script>
    const log = (...args) => {
      const output = document.getElementById('output');
      output.textContent += args.join(' ') + '\n';
      console.log(...args);
    };

    window.onload = () => {
      window.require.config({
        paths: {
          vs: 'https://cdn.jsdelivr.net/npm/monaco-editor@0.34.1/min/vs'
        }
      });

      window.require(['vs/editor/editor.main'], () => {
        const defaultCode = `// Connect to MetaMask and fetch a track from Audius
const { createWalletClient, custom, mainnet } = window.viem;

// Use only MetaMask (ignore Phantom)
const providers = window.ethereum?.providers || [window.ethereum];
const metamask = providers.find(p => p?.isMetaMask);

if (!metamask) {
  alert('MetaMask not found. Disable Phantom or other wallets for now.');
  throw new Error('MetaMask required');
}

// TEMP client to get address
const tempClient = createWalletClient({
  chain: mainnet,
  transport: custom(metamask),
});

const addresses = await tempClient.requestAddresses();
console.log("Wallet address:", addresses[0]);

// FINAL client with account attached
const audiusWalletClient = createWalletClient({
  account: addresses[0],
  chain: mainnet,
  transport: custom(metamask),
});

window.walletClient = audiusWalletClient;
window.walletAddress = addresses[0];

const sdk = window.audiusSdk({
  appName: 'MonacoApp',
  environment: 'staging',
  services: { audiusWalletClient }
});

console.log("âœ… Audius SDK initialized");

if (!sdk) {
  console.log("âŒ Audius SDK not initialized.");
  return;
}

const track = await sdk.tracks.getTrack({ trackId: 'D7KyD' });
console.log("ðŸŽµ Track fetched from Audius:", track.data.title);
`;

        window.editor = monaco.editor.create(document.getElementById('editor'), {
          value: defaultCode,
          language: 'javascript',
          theme: 'vs-dark',
        });
      });

      document.getElementById('runBtn').onclick = () => {
        const code = window.editor.getValue();
        const originalLog = console.log;
        const captured = [];

        console.log = (...args) => {
          captured.push(args.map(String).join(' '));
          originalLog(...args);
        };

        try {
          eval(`(async () => { ${code} })()`);
        } catch (e) {
          captured.push('Error: ' + e.message);
        } finally {
          document.getElementById('output').textContent = captured.join('\n');
          console.log = originalLog;
        }
      };
    };
  </script>
</body>

</html>
