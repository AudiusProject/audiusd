<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <title>Monaco TypeScript Runner</title>
  <style>
    * {
      box-sizing: border-box;
    }

    html,
    body {
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: system-ui, sans-serif;
      background-color: var(--bg);
      color: var(--fg);
    }

    #container {
      display: flex;
      flex-direction: column;
      height: 100%;
      padding: 12px;
      gap: 10px;
    }

    #editor {
      flex: 1;
      border-radius: 8px;
      overflow: hidden;
    }

    #run {
      align-self: flex-start;
      padding: 8px 16px;
      font-size: 16px;
      font-weight: 500;
      border: none;
      border-radius: 6px;
      background-color: #007acc;
      color: white;
      cursor: pointer;
      transition: background-color 0.2s ease;
    }

    #run:hover {
      background-color: #005fa3;
    }

    #output {
      height: 30vh;
      padding: 12px;
      border-radius: 6px;
      overflow-y: auto;
      background-color: #1e1e1e;
      color: #dcdcdc;
      font-family: "Fira Code", Consolas, monospace;
      font-size: 14px;
      white-space: pre-wrap;
      line-height: 1.5;
    }

    @media (prefers-color-scheme: light) {
      #output {
        background-color: #f3f3f3;
        color: #111;
      }
    }
  </style>
</head>

<body>
  <div id="container">
    <div id="editor"></div>
    <button id="run">Run (âŒ˜/Ctrl + S)</button>
    <div id="output"></div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/monaco-editor@0.44.0/min/vs/loader.js"></script>
  <script>
    require.config({ paths: { 'vs': 'https://cdn.jsdelivr.net/npm/monaco-editor@0.44.0/min/vs' } });
    require(['vs/editor/editor.main'], function () {
      const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
      monaco.editor.setTheme(prefersDark ? 'vs-dark' : 'vs');

      const editor = monaco.editor.create(document.getElementById('editor'), {
        value: `function greet(name: string) {\n  console.log("Hello, " + name);\n}\n\ngreet("TypeScript");`,
        language: 'typescript',
        theme: prefersDark ? 'vs-dark' : 'vs',
        automaticLayout: true,
        fontFamily: '"Fira Code", Consolas, monospace',
        fontSize: 14,
        padding: { top: 12, bottom: 12 }
      });

      const output = document.getElementById('output');
      const runButton = document.getElementById('run');

      function captureConsole() {
        const logs = [];
        const wrap = (fn, label) => (...args) => {
          logs.push(`<span style="color:${label === 'error' ? 'red' : 'limegreen'}">${label}: ${args.join(' ')}</span>`);
          console[`${label}Original`](...args);
        };
        ['log', 'error', 'warn', 'info'].forEach(method => {
          console[`${method}Original`] = console[method];
          console[method] = wrap(console[method], method);
        });
        return () => {
          ['log', 'error', 'warn', 'info'].forEach(method => {
            console[method] = console[`${method}Original`];
          });
          return logs;
        };
      }

      async function runCode() {
        output.innerHTML = '';
        const restoreConsole = captureConsole();

        try {
          const model = editor.getModel();
          const client = await monaco.languages.typescript.getTypeScriptWorker().then(worker => worker(model.uri));
          const result = await client.getEmitOutput(model.uri.toString());
          const js = result.outputFiles.find(f => f.name.endsWith('.js'))?.text;
          if (js) {
            new Function(js)();
          } else {
            console.error("No JS output");
          }
        } catch (e) {
          console.error(e);
        }

        const logs = restoreConsole();
        output.innerHTML = logs.join('<br>');
      }

      runButton.addEventListener('click', runCode);

      window.addEventListener('keydown', (e) => {
        if ((e.metaKey || e.ctrlKey) && e.key.toLowerCase() === 's') {
          e.preventDefault();
          runCode();
        }
      });
    });
  </script>
</body>

</html>
