syntax = "proto3";

package etl.v1;

import "google/protobuf/timestamp.proto";

option go_package = "github.com/AudiusProject/audiusd/pkg/api/etl/v1";

message PingRequest {}

message PingResponse {
  string message = 1;
}

message GetHealthRequest {}

message GetHealthResponse {}

message GetStatsRequest {}

message GetStatsResponse {
  int64 current_block_height = 1;
  string chain_id = 2;
  double bps = 3;
  double tps = 4;
  int64 total_transactions = 5;
  int64 total_transactions_24h = 6;
  int64 total_transactions_previous_24h = 7;
  int64 total_transactions_7d = 8;
  int64 total_transactions_30d = 9;
  int64 validator_count = 10;
  Block latest_block = 11;
  repeated string recent_proposers = 12;
  repeated TransactionTypeBreakdown transaction_breakdown = 13;
  SyncStatus sync_status = 14;
}

message TransactionTypeBreakdown {
  string type = 1;
  int64 count = 2;
}

message SyncStatus {
  bool is_syncing = 1;
  int64 latest_indexed_height = 2;
  int64 latest_chain_height = 3;
  int64 block_delta = 4;
}

message Block {
  int64 height = 1;
  string proposer = 2;
  google.protobuf.Timestamp timestamp = 3;

  message Transaction {
    string hash = 1;
    string type = 2;
    uint32 index = 3;
    google.protobuf.Timestamp timestamp = 4;
  }

  repeated Transaction transactions = 4;
}

message GetBlockRequest {
  int64 height = 1;
}

message GetBlockResponse {
  Block block = 1;
}

message GetBlocksRequest {
  int64 start_height = 1;
  int64 end_height = 2;
  int32 limit = 3;
  int32 offset = 4;
}

message GetBlocksResponse {
  repeated Block blocks = 1;
  bool has_more = 2;
  int32 total_count = 3;
}

message GetTransactionsRequest {
  int32 limit = 1;
  int32 offset = 2;
}

message GetTransactionsResponse {
  repeated Block.Transaction transactions = 1;
  bool has_more = 2;
  int32 total_count = 3;
}

message GetTransactionsByAddressRequest {
  string address = 1;
  int32 limit = 2;
  int32 offset = 3;
  optional string relation_filter = 4;
  optional google.protobuf.Timestamp start_date = 5;
  optional google.protobuf.Timestamp end_date = 6;
}

message GetTransactionsByAddressResponse {
  repeated AddressTransaction transactions = 1;
  bool has_more = 2;
  int32 total_count = 3;
}

message GetRelationTypesByAddressRequest {
  string address = 1;
}

message GetRelationTypesByAddressResponse {
  repeated string relation_types = 1;
}

message AddressTransaction {
  string tx_hash = 1;
  string tx_type = 2;
  int64 block_height = 3;
  int64 index = 4;
  string address = 5;
  string relation_type = 6;
  google.protobuf.Timestamp block_time = 7;
}

message GetTransactionRequest {
  string tx_hash = 1;
}

message GetTransactionResponse {
  Transaction transaction = 1;
}

message Transaction {
  string hash = 1;
  string type = 2;
  int64 block_height = 3;
  int64 index = 4;
  google.protobuf.Timestamp block_time = 5;
  string proposer_address = 6;

  oneof content {
    TrackPlaysTransaction plays = 100;
    ManageEntityTransaction manage_entity = 101;
    ValidatorRegistrationTransaction validator_registration = 102;
    ValidatorDeregistrationTransaction validator_deregistration = 103;
    SlaRollupTransaction sla_rollup = 104;
    StorageProofTransaction storage_proof = 105;
    StorageProofVerificationTransaction storage_proof_verification = 106;
    ReleaseTransaction release = 107;
  }
}

message TrackPlaysTransaction {
  repeated TrackPlay plays = 1;
}

message TrackPlay {
  string address = 1;
  string track_id = 2;
  google.protobuf.Timestamp played_at = 3;
  string city = 4;
  string region = 5;
  string country = 6;
  double latitude = 7;
  double longitude = 8;
}

message ManageEntityTransaction {
  repeated ManageEntity entities = 1;
}

message ManageEntity {
  string address = 1;
  string entity_type = 2;
  int64 entity_id = 3;
  string action = 4;
  string metadata = 5;
  string signature = 6;
  string signer = 7;
  string nonce = 8;
}

message ValidatorRegistrationTransaction {
  repeated ValidatorRegistration registrations = 1;
}

message ValidatorRegistration {
  string address = 1;
  string endpoint = 2;
  string comet_address = 3;
  string eth_block = 4;
  string node_type = 5;
  string spid = 6;
  bytes comet_pubkey = 7;
  int64 voting_power = 8;
}

message ValidatorDeregistrationTransaction {
  repeated ValidatorDeregistration deregistrations = 1;
}

message ValidatorDeregistration {
  string comet_address = 1;
  bytes comet_pubkey = 2;
}

message SlaRollupTransaction {
  google.protobuf.Timestamp timestamp = 1;
  int64 block_start = 2;
  int64 block_end = 3;
  repeated SlaNodeReport reports = 4;
}

message SlaNodeReport {
  string address = 1;
  int32 num_blocks_proposed = 2;
}

message StorageProofTransaction {
  int64 height = 1;
  string address = 2;
  repeated string prover_addresses = 3;
  string cid = 4;
  bytes proof_signature = 5;
}

message StorageProofVerificationTransaction {
  int64 height = 1;
  bytes proof = 2;
}

message ReleaseTransaction {
  bytes release_data = 1;
}

message GetPlaysRequest {
  oneof query {
    GetPlays get_plays = 1;
    GetPlaysByAddress get_plays_by_address = 2;
    GetPlaysByUser get_plays_by_user = 3;
    GetPlaysByTimeRange get_plays_by_time_range = 4;
    GetPlaysByLocation get_plays_by_location = 5;
  }
}

message GetPlays {}

message GetPlaysByAddress {}

message GetPlaysByUser {}

message GetPlaysByTrack {}

message GetPlaysByTimeRange {}

message GetPlaysByLocation {}

message GetPlaysResponse {
  repeated GetPlayResponse plays = 1;
}

message GetPlayResponse {
  string address = 1;
  string track_id = 2;
  int64 timestamp = 3;
  string city = 4;
  string country = 5;
  string region = 6;
  int64 block_height = 7;
  string tx_hash = 8;
}

message GetManageEntitiesRequest {}

message GetManageEntitiesResponse {
  repeated GetManageEntityResponse manage_entities = 1;
}

message GetManageEntityResponse {
  string address = 1;
  string entity_type = 2;
  int64 entity_id = 3;
  string action = 4;
  string metadata = 5;
  string signature = 6;
  string signer = 7;
  string nonce = 8;
  int64 block = 9;
  string tx_hash = 10;
}

message GetValidatorsRequest {
  oneof query {
    GetRegisteredValidators get_registered_validators = 1;
    GetValidatorRegistrations get_validator_registrations = 2;
    GetValidatorDeregistrations get_validator_deregistrations = 3;
  }
  int32 limit = 4;
  int32 offset = 5;
  optional string endpoint_filter = 6;
}

message GetRegisteredValidators {}
message GetValidatorRegistrations {}
message GetValidatorDeregistrations {}

message GetValidatorsResponse {
  repeated ValidatorInfo validators = 1;
  bool has_more = 2;
  int32 total_count = 3;
}

message GetValidatorRequest {
  oneof identifier {
    string address = 1;
    string comet_address = 2;
  }
}

message GetValidatorResponse {
  ValidatorInfo validator = 1;
  repeated ValidatorEvent events = 2;
}

message ValidatorInfo {
  string address = 1;
  string endpoint = 2;
  string comet_address = 3;
  string eth_block = 4;
  string node_type = 5;
  string spid = 6;
  bytes comet_pubkey = 7;
  int64 voting_power = 8;
  ValidatorStatus status = 9;
  google.protobuf.Timestamp registered_at = 10;
  google.protobuf.Timestamp last_activity = 11;
  int64 registration_block_height = 12;
  string registration_tx_hash = 13;
}

enum ValidatorStatus {
  VALIDATOR_STATUS_UNKNOWN_UNSPECIFIED = 0;
  VALIDATOR_STATUS_ACTIVE = 1;
  VALIDATOR_STATUS_DEREGISTERED = 2;
  VALIDATOR_STATUS_MISBEHAVIOR_DEREGISTERED = 3;
}

message ValidatorEvent {
  ValidatorEventType type = 1;
  google.protobuf.Timestamp timestamp = 2;
  int64 block_height = 3;
  string tx_hash = 4;
  ValidatorEventData data = 5;
}

enum ValidatorEventType {
  VALIDATOR_EVENT_TYPE_UNKNOWN_UNSPECIFIED = 0;
  VALIDATOR_EVENT_TYPE_REGISTRATION = 1;
  VALIDATOR_EVENT_TYPE_REGISTRATION_LEGACY = 2;
  VALIDATOR_EVENT_TYPE_DEREGISTRATION = 3;
  VALIDATOR_EVENT_TYPE_MISBEHAVIOR_DEREGISTRATION = 4;
}

message ValidatorEventData {
  oneof event {
    ValidatorRegistrationEvent registration = 1;
    ValidatorRegistrationLegacyEvent registration_legacy = 2;
    ValidatorDeregistrationEvent deregistration = 3;
    ValidatorMisbehaviorDeregistrationEvent misbehavior_deregistration = 4;
  }
}

message ValidatorRegistrationEvent {
  string address = 1;
  string endpoint = 2;
  string comet_address = 3;
  string eth_block = 4;
  string node_type = 5;
  string spid = 6;
  bytes comet_pubkey = 7;
  int64 voting_power = 8;
}

message ValidatorRegistrationLegacyEvent {
  string endpoint = 1;
  string comet_address = 2;
  string eth_block = 3;
  string node_type = 4;
  string sp_id = 5;
  bytes pub_key = 6;
  int64 power = 7;
}

message ValidatorDeregistrationEvent {
  string comet_address = 1;
  bytes comet_pubkey = 2;
}

message ValidatorMisbehaviorDeregistrationEvent {
  string comet_address = 1;
  bytes pub_key = 2;
}

message GetLocationRequest {
  oneof query {
    GetAvailableCities get_available_cities = 1;
    GetAvailableRegions get_available_regions = 2;
    GetAvailableCountries get_available_countries = 3;
  }
}

message GetAvailableCities {}
message GetAvailableRegions {}
message GetAvailableCountries {}

message GetLocationResponse {}

message SearchRequest {
  string query = 1;
  int32 limit = 2;
}

message SearchResponse {
  repeated SearchResult results = 1;
}

message SearchResult {
  string id = 1;
  string title = 2;
  string subtitle = 3;
  string type = 4;
  string url = 5;
}

message StreamRequest {
  message StreamBlocksRequest {}
  message StreamPlaysRequest {}

  oneof query {
    StreamBlocksRequest stream_blocks = 1;
    StreamPlaysRequest stream_plays = 2;
  }
}

message StreamResponse {
  message StreamBlocksResponse {
    int64 height = 1;
    string proposer = 2;
  }

  message StreamPlaysResponse {
    string city = 1;
    string country = 2;
    string region = 3;
    double latitude = 4;
    double longitude = 5;
  }
  oneof response {
    StreamBlocksResponse stream_blocks = 1;
    StreamPlaysResponse stream_plays = 2;
  }
}
